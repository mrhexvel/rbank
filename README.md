# Техническая Дока.

## Содержание
1. [Общая архитектура проекта](#общая-архитектура-проекта)
2. [Клиент-серверное взаимодействие](#клиент-серверное-взаимодействие)
3. [Структура базы данных](#структура-базы-данных)
4. [Аутентификация и авторизация](#аутентификация-и-авторизация)
5. [Основные компоненты и их функции](#основные-компоненты-и-их-функции)
6. [API эндпоинты](#api-эндпоинты)
7. [Маршрутизация и страницы](#маршрутизация-и-страницы)
8. [Стилизация и UI компоненты](#стилизация-и-ui-компоненты)
9. [Дополнительные технические детали](#дополнительные-технические-детали)

## Общая архитектура проекта

Проект RBank построен на основе фреймворка Next.js, который обеспечивает полноценную разработку как клиентской, так и серверной части приложения. Это позволяет создать единую кодовую базу для всего проекта.

### Ключевые технологии:

- **Next.js**: Фреймворк для React с серверным рендерингом и API-маршрутами
- **React**: Библиотека для создания пользовательского интерфейса
- **Prisma**: ORM для работы с базой данных
- **MySQL**: Реляционная база данных для хранения информации
- **JWT**: Технология для аутентификации пользователей
- **Tailwind CSS**: Утилитарный CSS-фреймворк для стилизации
- **TypeScript**: Типизированный JavaScript для более надежного кода

### Архитектурная схема:

```
┌─────────────────────────────────────────────────────────────┐
│                        Next.js App                          │
│                                                             │
│  ┌─────────────────────┐           ┌─────────────────────┐  │
│  │                     │           │                     │  │
│  │   Client (React)    │◄─────────►│   Server (Node.js)  │  │
│  │                     │   API     │                     │  │
│  └─────────────────────┘ Requests  └──────────┬──────────┘  │
│                                               │             │
│                                               │             │
│                                               ▼             │
│                                    ┌─────────────────────┐  │
│                                    │                     │  │
│                                    │   Prisma ORM        │  │
│                                    │                     │  │
│                                    └──────────┬──────────┘  │
│                                               │             │
└───────────────────────────────────────────────┼─────────────┘
                                                │
                                                ▼
                                    ┌─────────────────────┐
                                    │                     │
                                    │   MySQL Database    │
                                    │                     │
                                    └─────────────────────┘
```

## Клиент-серверное взаимодействие

В проекте RBank клиент-серверное взаимодействие реализовано через API-маршруты Next.js, которые выступают в роли бэкенд-сервера.

### Принцип работы:

1. **Клиентская часть** (React-компоненты) отправляет запросы к API-эндпоинтам
2. **Серверная часть** (API-маршруты) обрабатывает запросы, взаимодействует с базой данных и возвращает данные
3. **Prisma ORM** обеспечивает типобезопасное взаимодействие с базой данных

### Пример взаимодействия:

Когда пользователь открывает страницу дашборда, происходит следующее:

1. React-компонент `DashboardPage` монтируется в браузере
2. В хуке `useEffect` компонент отправляет запрос к `/api/user` для получения данных пользователя
3. API-маршрут `/api/user` проверяет JWT-токен из cookies
4. Если токен валиден, API-маршрут использует Prisma для запроса данных из базы данных
5. Данные возвращаются клиенту в формате JSON
6. React-компонент обновляет состояние и отображает полученные данные

```javascript
// Пример клиентского кода (упрощенно)
useEffect(() => {
  async function fetchUserData() {
    try {
      const response = await fetch("/api/user")
      if (!response.ok) {
        throw new Error("Не авторизован")
      }
      const data = await response.json()
      setUser(data.user)
    } catch (error) {
      router.push("/login")
    }
  }
  fetchUserData()
}, [router])
```

```javascript
// Пример серверного кода (упрощенно)
export async function GET() {
  try {
    const token = (await cookies()).get("auth_token")?.value
    if (!token) {
      return NextResponse.json({ message: "Not authenticated" }, { status: 401 })
    }
    
    const decoded = verify(token, JWT_SECRET)
    const user = await prisma.user.findUnique({
      where: { id: decoded.id },
      select: { id: true, name: true, email: true, accounts: true }
    })
    
    return NextResponse.json({ user })
  } catch (error) {
    return NextResponse.json({ message: "Internal server error" }, { status: 500 })
  }
}
```

## Структура базы данных

База данных проекта построена на MySQL и управляется через Prisma ORM. Схема базы данных определена в файле `prisma/schema.prisma`.

### Основные модели:

1. **User** - информация о пользователях
   - id, email, password, name, createdAt, updatedAt
   - связь one-to-many с моделью Account

2. **Account** - банковские счета пользователей
   - id, name, accountNumber, balance, type, createdAt, updatedAt
   - связь many-to-one с моделью User

3. **Transaction** - финансовые транзакции
   - id, amount, description, category, date, accountId

### Схема базы данных:

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│      User       │       │     Account     │       │   Transaction   │
├─────────────────┤       ├─────────────────┤       ├─────────────────┤
│ id              │       │ id              │       │ id              │
│ email           │       │ name            │       │ amount          │
│ password        │◄──────┤ userId          │       │ description     │
│ name            │       │ accountNumber   │       │ category        │
│ createdAt       │       │ balance         │◄──────┤ accountId       │
│ updatedAt       │       │ type            │       │ date            │
└─────────────────┘       │ createdAt       │       └─────────────────┘
                          │ updatedAt       │
                          └─────────────────┘
```

## Аутентификация и авторизация

В проекте используется JWT (JSON Web Tokens) для аутентификации и авторизации пользователей.

### Процесс аутентификации:

1. **Регистрация** (`/api/auth/register`):
   - Пользователь отправляет данные (имя, email, пароль)
   - Сервер проверяет уникальность email
   - Пароль хешируется с помощью bcrypt
   - Создается новый пользователь в базе данных
   - Возвращается успешный ответ

2. **Вход** (`/api/auth/login`):
   - Пользователь отправляет email и пароль
   - Сервер находит пользователя по email
   - Проверяется соответствие пароля с помощью bcrypt
   - Создается JWT-токен с данными пользователя
   - Токен сохраняется в HTTP-only cookie
   - Возвращаются данные пользователя

3. **Проверка аутентификации**:
   - При запросах к защищенным API-маршрутам сервер проверяет наличие и валидность JWT-токена в cookies
   - Если токен отсутствует или недействителен, возвращается ошибка 401
   - Если токен валиден, запрос обрабатывается и возвращаются запрошенные данные

4. **Выход** (`/api/auth/logout`):
   - Удаляется cookie с JWT-токеном
   - Пользователь перенаправляется на страницу входа

### Пример кода аутентификации:

```javascript
// Создание JWT-токена при входе
const token = sign(
  {
    id: user.id,
    email: user.email,
    name: user.name,
  },
  JWT_SECRET,
  { expiresIn: "1d" }
)

// Сохранение токена в cookie
;(await cookies()).set({
  name: "auth_token",
  value: token,
  httpOnly: true,
  path: "/",
  secure: process.env.NODE_ENV === "production",
  maxAge: 60 * 60 * 24, // 1 день
})
```

## Основные компоненты и их функции

Проект разделен на множество компонентов, каждый из которых отвечает за определенную функциональность.

### Ключевые компоненты:

1. **Компоненты страниц** (в директории `app/`):
   - `page.tsx` - главная страница сайта
   - `login/page.tsx` - страница входа
   - `register/page.tsx` - страница регистрации
   - `dashboard/page.tsx` - главная страница дашборда
   - `dashboard/accounts/page.tsx` - страница управления счетами
   - `dashboard/transactions/page.tsx` - страница транзакций
   - `dashboard/cards/page.tsx` - страница управления картами

2. **UI компоненты** (в директории `components/`):
   - `dashboard-sidebar.tsx` - боковая панель навигации дашборда
   - `dashboard-header.tsx` - верхняя панель дашборда
   - `accounts-list.tsx` - список счетов пользователя
   - `transaction-list.tsx` - список транзакций
   - `balance-chart.tsx` - график баланса
   - `analytics-view.tsx` - компонент аналитики
   - `navbar.tsx` - навигационная панель для публичных страниц
   - `footer.tsx` - подвал сайта

3. **Утилитарные компоненты**:
   - `glowing-border.tsx` - компонент для создания светящейся границы
   - `scroll-reveal.tsx` - компонент для анимации появления при прокрутке
   - `page-loader.tsx` - компонент загрузки страницы
   - `loader.tsx` - компонент индикатора загрузки

### Пример взаимодействия компонентов:

Страница дашборда (`dashboard/page.tsx`) использует несколько компонентов:
- `StatCard` для отображения статистики
- `BalanceChart` для отображения графика баланса
- `TransactionList` для отображения списка транзакций
- `AccountsList` для отображения списка счетов
- `AnalyticsView` для отображения аналитики

Каждый из этих компонентов самостоятельно запрашивает необходимые данные с сервера и отображает их.

## API эндпоинты

Проект содержит несколько API-эндпоинтов, которые обрабатывают запросы от клиентской части.

### Основные API-маршруты:

1. **Аутентификация**:
   - `POST /api/auth/register` - регистрация нового пользователя
   - `POST /api/auth/login` - вход пользователя
   - `GET /api/auth/logout` - выход пользователя

2. **Данные пользователя**:
   - `GET /api/user` - получение данных текущего пользователя

3. **Счета**:
   - `GET /api/accounts` - получение списка счетов пользователя

4. **Транзакции**:
   - `GET /api/transactions` - получение списка транзакций пользователя

### Пример API-маршрута:

```javascript
// app/api/accounts/route.ts
import { PrismaClient } from "@prisma/client"
import { verify } from "jsonwebtoken"
import { cookies } from "next/headers"
import { NextResponse } from "next/server"

const prisma = new PrismaClient()
const JWT_SECRET = process.env.JWT_SECRET || "your-secret-key"

export async function GET() {
  try {
    // Получаем токен из cookies
    const token = (await cookies()).get("auth_token")?.value

    if (!token) {
      return NextResponse.json({ message: "Не авторизован" }, { status: 401 })
    }

    // Проверяем токен
    try {
      const decoded = verify(token, JWT_SECRET) as {
        id: string
        email: string
        name: string
      }

      // Получаем счета пользователя из базы данных
      const accounts = await prisma.account.findMany({
        where: { userId: decoded.id },
        orderBy: { balance: "desc" },
      })

      // Возвращаем данные счетов
      return NextResponse.json({ accounts })
    } catch (error) {
      return NextResponse.json({ message: "Недействительный токен" }, { status: 401 })
    }
  } catch (error) {
    console.error("Ошибка при получении счетов:", error)
    return NextResponse.json({ message: "Внутренняя ошибка сервера" }, { status: 500 })
  } finally {
    await prisma.$disconnect()
  }
}
```

## Маршрутизация и страницы

Проект использует систему маршрутизации Next.js App Router, которая основана на файловой системе.

### Основные маршруты:

1. **Публичные страницы**:
   - `/` - главная страница
   - `/login` - страница входа
   - `/register` - страница регистрации

2. **Защищенные страницы** (требуют аутентификации):
   - `/dashboard` - главная страница дашборда
   - `/dashboard/accounts` - страница управления счетами
   - `/dashboard/transactions` - страница транзакций
   - `/dashboard/cards` - страница управления картами

### Защита маршрутов:

Защита маршрутов реализована на клиентской стороне с помощью проверки аутентификации в компонентах страниц:

```javascript
// Пример защиты маршрута в компоненте страницы
useEffect(() => {
  async function fetchUserData() {
    try {
      const response = await fetch("/api/user")
      if (!response.ok) {
        throw new Error("Не авторизован")
      }
      const data = await response.json()
      setUser(data.user)
    } catch (error) {
      router.push("/login") // Перенаправление на страницу входа
    }
  }
  fetchUserData()
}, [router])
```

## Стилизация и UI компоненты

Проект использует Tailwind CSS для стилизации и набор компонентов shadcn/ui.

### Основные элементы стилизации:

1. **Tailwind CSS**:
   - Утилитарные классы для стилизации компонентов
   - Настраиваемая тема с переменными CSS
   - Адаптивный дизайн для разных устройств

2. **Компоненты shadcn/ui**:
   - Кнопки, карточки, формы, модальные окна и другие UI-компоненты
   - Доступны через импорт из `@/components/ui`

3. **Кастомные компоненты**:
   - `GlowingBorder` - компонент для создания светящейся границы
   - `GlowingButton` - кнопка со светящимся эффектом
   - `ScrollReveal` - компонент для анимации появления при прокрутке

### Пример использования стилей:

```jsx
<Card className="backdrop-blur-sm bg-black/40 border-0 h-full">
  <CardHeader>
    <CardTitle>Обзор баланса</CardTitle>
    <CardDescription>Тренд вашего баланса за последние 30 дней</CardDescription>
  </CardHeader>
  <CardContent>
    <BalanceChart />
  </CardContent>
</Card>
```

## Дополнительные технические детали

### Управление состоянием:

Проект использует React Hooks для управления состоянием компонентов:
- `useState` для локального состояния компонентов
- `useEffect` для побочных эффектов, таких как запросы к API
- `useRouter` для программной навигации

### Валидация данных:

Для валидации данных форм используется библиотека Zod:
```javascript
const formSchema = z.object({
  email: z.string().email({
    message: "Пожалуйста, введите действительный адрес электронной почты.",
  }),
  password: z.string().min(1, {
    message: "Пароль обязателен.",
  }),
})
```

### Обработка ошибок:

Проект включает обработку ошибок на клиентской и серверной стороне:
- Перехват ошибок с помощью try/catch
- Отображение уведомлений об ошибках с помощью компонента Toast
- Логирование ошибок на сервере

### Оптимизация производительности:

- Использование Next.js для серверного рендеринга и оптимизации загрузки
- Ленивая загрузка компонентов с помощью динамического импорта
- Оптимизация изображений с помощью Next.js Image

### Безопасность:

- Хеширование паролей с помощью bcrypt
- Использование HTTP-only cookies для хранения JWT-токенов
- Проверка CSRF-токенов для защиты от CSRF-атак
- Валидация входных данных на сервере

---

## Заключение

Проект RBank представляет собой полноценное веб-приложение для онлайн-банкинга, построенное на современном стеке технологий. Архитектура проекта обеспечивает безопасное взаимодействие между клиентской и серверной частями, а также удобное управление данными через ORM Prisma.

Клиент-серверное взаимодействие реализовано через API-маршруты Next.js, что позволяет использовать единую кодовую базу для всего проекта. Аутентификация пользователей обеспечивается с помощью JWT-токенов, хранящихся в HTTP-only cookies.

Проект имеет модульную структуру, где каждый компонент отвечает за определенную функциональность, что облегчает поддержку и расширение приложения в будущем.
